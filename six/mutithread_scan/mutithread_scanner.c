#include<stdio.h>#include<stdlib.h>#include<string.h>#include<sys/types.h>#include<sys/socket.h>#include<netinet/in.h>#include<netdb.h>#include<pthread.h>#define SCANLENGTH 655   //每个线程分配655个端口#define THREADNUM 100   //100个线程#define START_PORT 1    //起始端口号#define END_PORT 65535  //结束端口号struct Port   //定义端口结构体{	int scan_minPort;	int scan_maxPort;	char *IP;	}Port;void print_usage(char *str);//打印出错信息void *scan(void * arg);//声明扫描函数int main(int argc, char *argv[]){	int ret;	struct sockaddr_in server;	struct servent *serve;	if(argc < 2)	{		print_usage(argv[0]);		exit(1);	}//创建100个线程描述符 	pthread_t *thread;	thread = (pthread_t*) malloc (THREADNUM*sizeof(pthread_t));	int j;	int i;//为每个线程创建扫描的分工	for(j=1; j<argc; ++j)	{		for(i=0; i<THREADNUM; ++i)		{			struct Port *port = (struct Port *)malloc(sizeof(struct Port)) ;			port->IP = argv[j];			port->scan_minPort = i*SCANLENGTH+1;			if(i == (THREADNUM-1))				port->scan_maxPort = END_PORT;			else				port->scan_maxPort = port->scan_minPort+SCANLENGTH-1;//创建线程，开始扫描 			if(pthread_create(&thread[i],NULL,(void *)scan,(void *)port)!=0)			{				perror("thead_create error!\n");				free(thread);// 释放创建的资源 				exit(-1);			}		}	}	pthread_join(thread[99],NULL);	return 0;}void print_usage(char *str){	printf("the command %s usage is: \n",str);	printf("%s IP_ADDRESS IP_ADDRESS IP_ADDRESS \n",str);}//扫描函数的实现void *scan(void * arg){	pthread_detach(pthread_self());	int sockfd;	int ret;	int opt = SO_REUSEADDR;	struct sockaddr_in server;	struct servent *serve;	char **name;	struct Port* port = (struct Port*)arg;	int start;	int end;	int scanPort;	start = port->scan_minPort;	end = port->scan_maxPort;	for(scanPort = start; scanPort!=end; scanPort++)	{		if(-1 == (sockfd = socket(AF_INET,SOCK_STREAM,0)))		{			perror("socket failed!\n");			exit(-1);		}		setsockopt(sockfd,SOL_SOCKET,SO_REUSEADDR,&opt,sizeof(opt));		memset(&server,0,sizeof(server));		server.sin_family = AF_INET;		server.sin_addr.s_addr = inet_addr(port->IP);		server.sin_port = htons(scanPort);		ret = connect(sockfd,(struct sockaddr*)&server,sizeof(struct sockaddr))+1;		if(ret == 0)		{			close(sockfd);			continue;		}		else if(ret == 1)		{			if((serve = getservbyport(htons(scanPort),"tcp"))==NULL)				printf("IP=%s scanPort=%d  Unknown service\n",port->IP,scanPort);			else			{				printf("IP=%s scanPort=%d  s_name=%s\n",port->IP,scanPort,serve->s_name);				for(name=serve->s_aliases;*name!=NULL;name++)					printf("IP=%s scanPort=%d  aliase name is %s\n",port->IP,scanPort,*name);			}			close(sockfd);		}	}}